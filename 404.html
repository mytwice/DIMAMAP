<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIMA MAP</title>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #ffffff;
            overflow: hidden; /* í˜ì´ì§€ì—ì„œ ìŠ¤í¬ë¡¤ë°”ë¥¼ ìˆ¨ê¹ë‹ˆë‹¤ */
        }

        #map-wrapper {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
            background: #8b8b8b;
        }

        #map-container {
            position: absolute;
            transform-origin: 0 0;
            cursor: grab;
            width: 100%;
            height: 100%;
        }

        #map-container:active {
            cursor: grabbing;
        }

        #map-image {
            width: 1200px;
            height: 900px;
            user-select: none;
            object-fit: contain; 
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            -webkit-user-drag: none;
            -khtml-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
        }

        /* ìƒë‹¨ ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .control-panel {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 1200px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 9999;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;  /* í•­ëª©ë“¤ì„ ì¤„ ë°”ê¿ˆì´ ê°€ëŠ¥í•˜ê²Œ í•¨ */
            gap: 16px;  /* í•­ëª© ê°„ì˜ ê°„ê²© */
        }

            /* ê²€ìƒ‰ì°½ */
            .search-container {
            left: 50%;
            display: flex;

            gap: 40px; /* íƒ€ì´í‹€ê³¼ ê²€ìƒ‰ì°½ ê°„ ê°„ê²© */
            margin-bottom: 00px; /* ì»¨í…Œì´ë„ˆ ê°„ ê°„ê²© */
        }

        .search-results {
            position: absolute;
            top: 100%;  /* ì…ë ¥ í•„ë“œ ë°”ë¡œ ì•„ë˜ ë°°ì¹˜ */
            left: 0;
            width: 100%;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-height: 200px; /* ê²€ìƒ‰ ê²°ê³¼ê°€ ë„ˆë¬´ ê¸¸ì–´ì§€ì§€ ì•Šë„ë¡ ì œí•œ */
            overflow-y: auto; /* ìŠ¤í¬ë¡¤ ê°€ëŠ¥ */
            display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
        }

        .search-result-item {
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background: #f0f0f0;
        }

        .search-title {
            font-size: 22px;
            font-weight: bold;
            color: #333;
        }

        .search-input {
            flex: 1; /* ì…ë ¥ ì°½ì´ ë‚¨ì€ ê³µê°„ì„ ì°¨ì§€í•˜ë„ë¡ ì„¤ì • */
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        /* í•„í„°ë§ ê·¸ë£¹ì„ 1ì¤„ì— ë°°ì¹˜ */
        .filter-group {
            display: flex;
            gap: 16px;
            flex-wrap: nowrap;  /* í•„í„° ê·¸ë£¹ì€ í•œ ì¤„ì— ë°°ì¹˜ */
        }

        #category-filter {
            display: flex;
            flex-wrap: nowrap;  /* í•œ ì¤„ë¡œ ë°°ì¹˜ */
            gap: 10px;
            width: 100%;  /* ì „ì²´ ë„ˆë¹„ ì‚¬ìš© */
            overflow-x: auto;  /* ê°€ë¡œ ìŠ¤í¬ë¡¤ì„ ì¶”ê°€ */
            padding-bottom: 10px;  /* ìŠ¤í¬ë¡¤ë°”ê°€ ë³´ì´ë„ë¡ ì•„ë˜ ì—¬ë°± ì¶”ê°€ */
        }

        #category-filter label {
            background: #e155b5;
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            white-space: nowrap;
            font-size: 14px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 14px;
        }

        .filter-select {
            width: 150px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .filter-button {
            padding: 12px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .filter-button:hover {
            background: #1976D2;
        }

        /* í•€ ë° ì •ë³´ ë°•ìŠ¤ */
        .pin {
            position: absolute;
            width: 30px;
            height: 30px;
            z-index: 1000;
            cursor: pointer;
            transform: translate(-50%, -95%);
            transition: transform 0.2s;
        }


        /* 1ìˆœìœ„ í•€ ìŠ¤íƒ€ì¼ - ë§ˆì»¤ ëª¨ì–‘ */
        .pin-primary::before {
            content: '';
            position: absolute;
            width: 30px;
            height: 30px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23E91E63"><path d="M12 0C7.6 0 4 3.6 4 8c0 5.4 8 16 8 16s8-10.6 8-16c0-4.4-3.6-8-8-8zm0 12c-2.2 0-4-1.8-4-4s1.8-4 4-4 4 1.8 4 4-1.8 4-4 4z"/></svg>') no-repeat center center;
            background-size: contain;
        }

        /* 2ìˆœìœ„ í•€ ìŠ¤íƒ€ì¼ - ì›í˜• */
        .pin-secondary {
            position: absolute; /* Ensure absolute positioning */
            width: 1px; /* Fixed width */
            height: 1px; /* Fixed height */
            background-color: #E91E63; /* Pink color */
            border-radius: 50%; /* Circular shape */
            border: 1px solid white; /* White border */
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); /* Subtle shadow */
            transform: translate(-50%, -50%); /* Center the pin */
            z-index: 1000; /* Ensure it's above other elements */
        }

        /* í•€ ë¼ë²¨ ìŠ¤íƒ€ì¼ */
        .pin-label {
            position: absolute;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            font-size: 7px;
            transform: translate(77%, 20%);
            border-radius: 5px;
            white-space: nowrap;
            text-align: center;
            display: none;
            z-index: 1001;
            transition: all 0.2s ease-in-out;
        }

        .pin-label2 {
            position: absolute;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            font-size: 7px;
            transform: translate(20%, -46%);
            border-radius: 5px;
            white-space: nowrap;
            text-align: center;
            display: none;
            z-index: 1001;
            transition: all 0.2s ease-in-out;
        }
        
        .pin-info-box {
            position: fixed;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            z-index: 1001;
            max-width: 300px;
            font-size: 14px;
            line-height: 1.6;
        }

        .pin-info-box strong {
            color: #333;
            display: inline-block;
            width: 80px;
        }

        .pin-info-box a {
            color: #2196F3;
            text-decoration: none;
        }

        .pin-info-box a:hover {
            text-decoration: underline;
        }

        .pin-info-box .close-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 18px;
            cursor: pointer;
            color: #666;
            line-height: 1;
        }

        .pin-info-box .close-btn:hover {
            color: #333;
        }

        /* ì¹´í…Œê³ ë¦¬ ìŠ¤í¬ë¡¤ */
        .category-scroll {
            display: flex;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding: 10px 0;
            gap: 10px;
        }

        .category-item {
            flex: 0 0 auto;
            padding: 8px 16px;
            background: #f0f0f0;
            border-radius: 20px;
            white-space: nowrap;
        }

    /* ê¸°ì¡´ .mobile-nav ìŠ¤íƒ€ì¼ì„ ìˆ˜ì • */
    .mobile-nav {
        display: flex;
        position: fixed;
        flex-direction: column;
        right: 0;
        top: 50%;
        transform: translateY(-50%);
        background: white;
        padding: 15px;
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        border-radius: 10px 0 0 10px;
    }

    /* ë„¤ë¹„ê²Œì´ì…˜ í•­ëª© ìŠ¤íƒ€ì¼ ìˆ˜ì • */
    .mobile-nav a {
        padding: 12px;
        text-align: left;
        border-right: none;
        border-bottom: 1px solid #ddd;
        text-decoration: none;
        color: #666
    }

    .mobile-nav a:last-child {
        border-bottom: none;
    }

    /* ë„¤ë¹„ê²Œì´ì…˜ ë°” ìš°ìƒë‹¨ì— ì´ë¯¸ì§€ì™€ í…ìŠ¤íŠ¸ */
    .nav-logo {
        display: flex;
        align-items: center;
        position: absolute;
        bottom: 30px;
        right: 50px;
    }

        /* íŒì—… ê¸°ë³¸ ìˆ¨ê¹€ */
    .popup {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5); /* ë°˜íˆ¬ëª… ë°°ê²½ */
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }

    /* íŒì—… ë‚´ìš© ìŠ¤íƒ€ì¼ */
    .popup-content {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        text-align: center;
        width: 300px;
        position: relative;
    }

    /* ë‹«ê¸° ë²„íŠ¼ */
    .close {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 20px;
        cursor: pointer;
    }

    /* ë¡œê³  ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
    .logo-img {
        width: 140px; /* ì´ë¯¸ì§€ í¬ê¸° ì„¤ì • */
        height: auto;
        -webkit-user-drag: none;
        -khtml-user-drag: none;
        -moz-user-drag: none;
        -o-user-drag: none;
    }

    /* ë¡œê³  í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    .logo-text {
        font-size: 13px; /* í…ìŠ¤íŠ¸ í¬ê¸° */
        font-weight: bold;
        margin-right: 20px; /* ì´ë¯¸ì§€ì™€ í…ìŠ¤íŠ¸ ì‚¬ì´ ì—¬ë°± */
        color: #f9f9f9; /* í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
    }

    .building-list {
        position: fixed;
        bottom: 0px;
        left: 0;
        right: 0;
        background: white;
        border-radius: 15px 15px 0 0;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        z-index: 999;
        height: 30vh; /* ê³ ì • ë†’ì´ ì„¤ì • */
        display: flex;
        flex-direction: column;
        overflow-y: auto; /* ì„¸ë¡œ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ ì„¤ì • */
        -webkit-overflow-scrolling: touch; /* ëª¨ë°”ì¼ì—ì„œ ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ */
    }

.building-container {
    padding: 20px;
}

.building-section {
    margin-bottom: 20px;
}

.building-section h3 {
    margin: 0 0 10px 0;
    color: #333;
    font-size: 16px;
}

.floor-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.floor-item {
    background: #f0f0f0;
    border: none;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    color: #333;
    cursor: pointer;
}

.floor-item:hover {
    background: #e0e0e0;
}

.locations-list {
        margin-top: 10px;
    }
    
    .location-item {
        padding: 8px;
        margin: 4px 0;
        background: #f8f8f8;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
    }
    
    .location-item:hover {
        background: #f0f0f0;
    }

        
    @media (max-width: 768px) {
        /* ëª¨ë°”ì¼ í™”ë©´ì—ì„œëŠ” í•˜ë‹¨ì— í‘œì‹œ */
    .mobile-nav {
        flex-direction: row;
        bottom: 0;
        left: 0;
        right: 0;
        top: auto;
        transform: none;
        padding: 18px 0;
        justify-content: space-around;
        border-radius: 0;
    }

    .mobile-nav a {
        padding: 0px;
        text-align: center;
        flex-grow: 1;
        border-bottom: none;
        border-right: 1px solid #ddd;
    }

            /* ë„¤ë¹„ê²Œì´ì…˜ ë°” ìš°ìƒë‹¨ì— ì´ë¯¸ì§€ì™€ í…ìŠ¤íŠ¸ */
    .nav-logo {
        display: flex;
        align-items: center;
        position: absolute;
        bottom: 90px;
        right: 10px;
        -webkit-user-drag: none;
        -khtml-user-drag: none;
        -moz-user-drag: none;
        -o-user-drag: none;
    }

    /* ë¡œê³  ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
    .logo-img {
        width: 130px; /* ì´ë¯¸ì§€ í¬ê¸° ì„¤ì • */
        height: auto;
    }

    /* ë¡œê³  í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    .logo-text {
        font-size: 12px; /* í…ìŠ¤íŠ¸ í¬ê¸° */
        font-weight: bold;
        margin-right: 20px; /* ì´ë¯¸ì§€ì™€ í…ìŠ¤íŠ¸ ì‚¬ì´ ì—¬ë°± */
        color: #f9f9f9; /* í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
    }
    .control-panel {
        position: fixed;
        top: 6px;
        left: 50%;
        width: 100%;
        background: white;
        padding: 10px 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        background: transparent;
        box-shadow: none;
        padding: 30px;
    }

    /* ëª¨ë°”ì¼ ë„¤ë¹„ê²Œì´ì…˜ */
.mobile-nav {
    display: flex;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    padding: 18px 0;
    justify-content: space-around;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
    z-index: 1000;
}

/* ë„¤ë¹„ê²Œì´ì…˜ í•­ëª© ì‚¬ì´ì— êµ¬ë¶„ì„  ì¶”ê°€ */
.mobile-nav a {
    padding: 0px;
    text-align: center;
    flex-grow: 1;
    border-right: 1px solid #ddd; /* í•­ëª© ì‚¬ì´ì— êµ¬ë¶„ì„  */
}

    /* ë§ˆì§€ë§‰ í•­ëª©ì˜ êµ¬ë¶„ì„  ì—†ì• ê¸° */
    .mobile-nav a:last-child {
        border-right: none;
    }

    .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-decoration: none;
        color: #666;
        font-size: 15px;
        gap: 4px;
    }

    
    .filter-group {
        display: none; /* í•„í„° ê·¸ë£¹ ìˆ¨ê¹€ */
    }
    
    .bottom-nav {
        display: block; /* ëª¨ë°”ì¼ì—ì„œë§Œ í‘œì‹œ */
    }
    
    #map-wrapper {
        padding-bottom: 10px; /* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë†’ì´ë§Œí¼ ì—¬ë°± */
    }
    
    /* ì¹´í…Œê³ ë¦¬ ìŠ¤í¬ë¡¤ í™œì„±í™” */
    #category-filter {
        display: flex;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        padding: 10px 0;
        gap: 10px;
        width: 86%;
        margin: 0 auto;
    }
    
    #category-filter label {
        flex: 0 0 auto;
        padding: 8px 16px;
        background: #f0f0f0;
        border-radius: 20px;
        white-space: nowrap;
    }

    /* ê²€ìƒ‰ì°½ì„ ì¤‘ì•™ì— ë°°ì¹˜ */
    .search-container {
        background: white;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        width: 85%;
        max-width: 800px; /* ìµœëŒ€ ë„ˆë¹„ ì„¤ì • */
        margin: 0 auto; /* ìë™ìœ¼ë¡œ ì¢Œìš° ì—¬ë°± */
    }

    .search-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

    .search-input {
        border: none;
        padding: 8px;
        width: 100%;
        font-size: 16px;
    }

    .search-results {
        margin: 0 auto;
        width: 78%; /* ëª¨ë°”ì¼ì—ì„œëŠ” ë¶€ëª¨ ìš”ì†Œ ëŒ€ë¹„ 90% ë„ˆë¹„ */
        font-size: 16px; /* ê°€ë…ì„± ì¦ê°€ */
        left: 10%;
}
    /* ì¹´í…Œê³ ë¦¬ ìŠ¤íƒ€ì¼ */
    #category-filter {
        display: flex;
        gap: 10px;
        overflow-x: auto;
        padding: 10px 0;
        -webkit-overflow-scrolling: touch;
    }

    #category-filter label {
        background: #e155b5;
        color: white;
        padding: 8px 20px;
        border-radius: 20px;
        white-space: nowrap;
        font-size: 14px;
    }

    /* í•˜ë‹¨ ê±´ë¬¼ ì •ë³´ */
    .bottom-info {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #4267B2;
        color: white;
        padding: 20px;
        border-radius: 15px 15px 0 0;
    }

    .bottom-info div {
        margin: 5px 0;
        font-size: 16px;
    }

    .building-list {
        bottom: 70px;
    }
}

.pin-info-box {
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 54%; /* ëª¨ë°”ì¼ í™”ë©´ì—ì„œì˜ ë„ˆë¹„ */
        max-width: 300px;
        z-index: 1002; /* ë‹¤ë¥¸ ìš”ì†Œë“¤ë³´ë‹¤ ìœ„ì— í‘œì‹œ */
    }

    @media (max-width: 480px) {
        /* ì‘ì€ í™”ë©´ì—ì„œ ë¼ë²¨ í¬ê¸° ë° ì…ë ¥ í¬ê¸° ì¡°ì • */
        .search-input {
            font-size: 14px;
            padding: 6px;
        }

        .filter-select {
            font-size: 14px;
            padding: 6px;
        }
    }
    </style>
</head>
<body>
    <div class="control-panel">
        <!-- ê²€ìƒ‰ ì°½ -->
        <div class="search-container">
            <span class="search-title">DIMA MAP</span> <!-- íƒ€ì´í‹€ ì¶”ê°€ -->
            <input type="text" class="search-input" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." id="search-input">
            <div class="search-results" id="search-results"></div>
        </div>

        <!-- í•„í„°ë§ -->
        <div class="filter-group">
            <label for="building-filter">ê±´ë¬¼</label>
            <select id="building-filter" class="filter-select"></select>

            <label for="floor-filter">ì¸µ</label>
            <select id="floor-filter" class="filter-select"></select>
        </div>

        <!-- ì¹´í…Œê³ ë¦¬ í•„í„° -->
        <div id="category-filter">
            <label><input type="checkbox" name="category" value=""> ì „ì²´</label>
            <!-- ë™ì ìœ¼ë¡œ ì¹´í…Œê³ ë¦¬ ë¼ë””ì˜¤ ë²„íŠ¼ ì¶”ê°€ -->
        </div>
    </div>

    <div id="map-wrapper">
        <div id="map-container">
            <img id="map-image" src="map.png" alt="ì§€ë„" draggable="false">
        </div>
    </div>

    <div class="nav-logo">
        <span class="logo-text">ìœ„ì„± ì œê³µ ã…£ êµ­í† ì§€ë¦¬ì •ë³´ì›</span>
        <img src="sub0705_01_Open_Mark_01.jpg" alt="êµ­í† ì§€ë¦¬ì •ë³´ì›" class="logo-img">
    </div>

    <div class="building-list" style="display: none;">
        <div class="building-container">
            <!-- ê±´ë¬¼ê³¼ ì¸µ ì •ë³´ê°€ ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
        </div>
    </div>

    <nav class="mobile-nav">
        <a href="https://mytwice.github.io/DIMAMAP/" class="nav-item">
            <span>ğŸ </span>
            <span>í™ˆ</span>
        </a>
        <a href="#" class="nav-item">
            <span>ğŸ”</span>
            <span>ê±´ë¬¼</span>
        </a>
        <a href="#" class="nav-item">
            <span>ğŸ“</span>
            <span>ì•ˆì „ì§€ë„</span>
        </a>
        <a href="#" class="nav-item" id="openPopup">
            <span>â„¹ï¸</span>
            <span>ì œë³´/ì •ë³´</span>
        </a>
    </nav>

    <!-- íŒì—… ì°½ -->
<div id="popup" class="popup">
    <div class="popup-content">
        <span class="close">&times;</span>
        <h2>ì œë³´/ì •ë³´</h2>
        <p style="word-break: keep-all;">ì˜ëª»ëœ ì •ë³´ë‚˜ ì¶”ê°€í•  ì‚¬í•­ì´ ìˆì„ ê²½ìš°ì— ì–¸ì œë“  ì—°ë½ì£¼ì„¸ìš”!</p>
        <p>ì œì‘ : I DIMA í”„ë¡œì íŠ¸</p>
        <a href="https://mytwice.github.io/I-DIMA/" target="_blank">ì‚¬ì´íŠ¸ ë°©ë¬¸í•˜ê¸°</a>
    </div>
</div>
</body>

<script>
// ë³€ìˆ˜ ì„ ì–¸
const mapWrapper = document.getElementById('map-wrapper');
const mapContainer = document.getElementById('map-container');
const searchInput = document.getElementById('search-input');
const searchResults = document.getElementById('search-results');
let pins = [];
let isDragging = false;
let startX, startY;
let currentTranslateX = 0, currentTranslateY = 0, currentScale = 1;
let mode = 'move';
let selectedPin = null;
let activeInfoBox = null;
let lastTouchDistance = 0;
let zoomAnimation;
let initialTouchX, initialTouchY;
let isTouchMoving = false;
let lastTouchTime = 0;
const TOUCH_DELAY = 300; // ë”ë¸”íƒ­ ê°ì§€ë¥¼ ìœ„í•œ ì‹œê°„ ê°„ê²© (ms)

// ë§µ ì„¤ì •
const mapConfig = {
    initialScale: 2.6,        // 2.6ì—ì„œ 1.7ë¡œ ë³€ê²½
    initialX: -550,           // 0ì—ì„œ -70ìœ¼ë¡œ ë³€ê²½
    initialY: -630,
    minScale: 1.0,            // 2.5ì—ì„œ 0ìœ¼ë¡œ ë³€ê²½
    maxScale: 9,
    zoomSpeed: 1,
    mobile: {
        initialScale: 1.2,
        initialX: -460,
        initialY: -10
    }
};

// í•€ ë°ì´í„°
const pinsData = [
  {
    "id": "1738332945823",
    "x": "539.20",
    "y": "161.20",
    "building": "",
    "floor": "",
    "category": "",
    "name": "",
    "description": "",
    "address": "",
    "priority": "ì—†ìŒ"
  },
  {
    "id": "1738332949708",
    "x": "581.20",
    "y": "420.20",
    "building": "ê¸°ì˜ˆê´€",
    "floor": "",
    "category": "",
    "name": "ê¸°ì˜ˆê´€",
    "description": "",
    "address": "",
    "priority": "1ìˆœìœ„"
  },
  {
    "id": "1738332951394",
    "x": "579.20",
    "y": "443.20",
    "building": "ì§€ì„±ê´€",
    "floor": "",
    "category": "",
    "name": "ì§€ì„±ê´€",
    "description": "",
    "address": "",
    "priority": "1ìˆœìœ„"
  },
  {
    "id": "1738332954413",
    "x": "584.20",
    "y": "391.20",
    "building": "ë•ì„±ê´€",
    "floor": "",
    "category": "",
    "name": "ë•ì„±ê´€",
    "description": "",
    "address": "",
    "priority": "1ìˆœìœ„"
  },
  {
    "id": "1738332957269",
    "x": "545.20",
    "y": "503.20",
    "building": "",
    "floor": "",
    "category": "",
    "name": "ì²´ìœ¡ê´€",
    "description": "",
    "address": "",
    "priority": "1ìˆœìœ„"
  },
  {
    "id": "1738332961017",
    "x": "573.20",
    "y": "495.20",
    "building": "",
    "floor": "",
    "category": "ì •ë¥˜ì¥",
    "name": "ìš´ë™ì¥ ì •ë¥˜ì†Œ",
    "description": "",
    "address": "",
    "priority": "3ìˆœìœ„"
  },
  {
    "id": "1738332964340",
    "x": "634.20",
    "y": "479.20",
    "building": "",
    "floor": "",
    "category": "",
    "name": "ì•¼ì™¸ê³µì—°ì¥",
    "description": "í•œë²ˆë„ ê³µì—°í•˜ëŠ”ê±¸ëª»ë³¸ ê³µì—°ì¥",
    "address": "",
    "priority": "3ìˆœìœ„"
  },
  {
    "id": "1738333075127",
    "x": "605.20",
    "y": "388.20",
    "building": "ë•ì„±ê´€",
    "floor": "4ì¸µ",
    "category": "ì‹¤ìŠµì‹¤",
    "name": "C3 ìŠ¤íŠœë””ì˜¤",
    "description": "ê°ì¢… ìƒë°©ì†¡ì´ ì œì‘ë˜ëŠ” ì¤‘í˜•ìŠ¤íŠœë””ì˜¤",
    "address": "",
    "priority": "2ìˆœìœ„"
  },
  {
    "id": "1738333078150",
    "x": "567.20",
    "y": "394.20",
    "building": "ë•ì„±ê´€",
    "floor": "2ì¸µ",
    "category": "ê°•ì˜ì‹¤",
    "name": "40201 ê°•ì˜ì‹¤",
    "description": "êµì‹¤í˜• ë¹”í”„ë¡œì íŠ¸ ê°•ì˜ì‹¤",
    "address": "",
    "priority": "2ìˆœìœ„"
  },
  {
    "id": "1738333085774",
    "x": "609.20",
    "y": "414.20",
    "building": "ê¸°ì˜ˆê´€",
    "floor": "1ì¸µ",
    "category": "ì‹¤ìŠµì‹¤",
    "name": "HD ìŠ¤íŠœë””ì˜¤",
    "description": "ê±°ëŒ€í•œ ìŠ¤íŠœë””ì˜¤",
    "address": "",
    "priority": "2ìˆœìœ„"
  },
  {
    "id": "1738333087372",
    "x": "617.20",
    "y": "418.20",
    "building": "ê¸°ì˜ˆê´€",
    "floor": "4ì¸µ",
    "category": "ì‹¤ìŠµì‹¤",
    "name": "ê°œë°©í¸ì§‘ì‹¤",
    "description": "ë“¤ì–´ê°€ë©´ ëª» ë¹ ì ¸ë‚˜ì˜¬ì§€ë„",
    "address": "",
    "priority": "2ìˆœìœ„"
  },
  {
    "id": "1738333095196",
    "x": "600.20",
    "y": "420.20",
    "building": "",
    "floor": "",
    "category": "",
    "name": "",
    "description": "",
    "address": "",
    "priority": "ì—†ìŒ"
  },
  {
    "id": "1738333100871",
    "x": "561.20",
    "y": "440.20",
    "building": "ì§€ì„±ê´€",
    "floor": "4ì¸µ",
    "category": "êµìˆ˜ì—°êµ¬ì‹¤",
    "name": "ì—°êµ¬ì‹¤",
    "description": "ê°€ë©´ ëª» ë¹ ì ¸ë‚˜ì˜¬ì§€ë„",
    "address": "",
    "priority": "2ìˆœìœ„"
  },
  {
    "id": "1738333107596",
    "x": "557.20",
    "y": "467.20",
    "building": "",
    "floor": "",
    "category": "ë„ì„œê´€ë¶€ì†ì‹œì„¤",
    "name": "ë„ì„œê´€",
    "description": "ì•”íŠ¼ ì „ë¬¸ëŒ€ ìˆœìœ„ê¶Œ ë„ì„œê´€",
    "address": "https://lib.dima.ac.kr/",
    "priority": "3ìˆœìœ„"
  },
  {
    "id": "1738333116090",
    "x": "587.20",
    "y": "141.20",
    "building": "ì˜ˆì¸ê´€",
    "floor": "B1ì¸µ",
    "category": "í¸ì˜ì‹œì„¤",
    "name": "GS25 í¸ì˜ì ",
    "description": "",
    "address": "",
    "priority": "2ìˆœìœ„"
  },
  {
    "id": "1738333131234",
    "x": "544.20",
    "y": "151.20",
    "building": "",
    "floor": "",
    "category": "",
    "name": "",
    "description": "",
    "address": "",
    "priority": "ì—†ìŒ"
  },
  {
    "id": "1738333143140",
    "x": "607.20",
    "y": "446.20",
    "building": "ì§€ì„±ê´€",
    "floor": "2ì¸µ",
    "category": "ê³µì—°ì‹œì„¤",
    "name": "ì½˜ì„œíŠ¸í™€",
    "description": "ì†Œí˜•ê·œëª¨ì˜ ê³µì—°ì¥",
    "address": "",
    "priority": "2ìˆœìœ„"
  },
  {
    "id": "1738333146582",
    "x": "616.20",
    "y": "461.20",
    "building": "ì§€ì„±ê´€",
    "floor": "5ì¸µ",
    "category": "í–‰ì •ì‹œì„¤",
    "name": "í•™ìƒíšŒì‹¤",
    "description": "ë“¤ì–´ê°€ë³´ê³  ì‹¶ë‹¤",
    "address": "",
    "priority": "2ìˆœìœ„"
  },
  {
    "id": "1738333412722",
    "x": "605.20",
    "y": "512.20",
    "building": "",
    "floor": "",
    "category": "ì²´ìœ¡ì‹œì„¤",
    "name": "ìš´ë™ì¥",
    "description": "",
    "address": "",
    "priority": "3ìˆœìœ„"
  },
  {
    "id": "1738333439589",
    "x": "605.20",
    "y": "454.20",
    "building": "",
    "floor": "ì‹¤ì™¸",
    "category": "í¸ì˜ì‹œì„¤",
    "name": "í•œìš¸ë§ˆë‹¹",
    "description": "ëª¨ë‘ì˜ ì‰¼í„° í•œìš¸ë§ˆë‹¹!",
    "address": "",
    "priority": "3ìˆœìœ„"
  },
  {
    "id": "1738461992899",
    "x": "574.80",
    "y": "137.20",
    "building": "ì˜ˆì¸ê´€",
    "floor": "",
    "category": "",
    "name": "ì˜ˆì¸ê´€",
    "description": "",
    "address": "",
    "priority": "1ìˆœìœ„"
  }
]

// í•„í„° ì˜µì…˜ ì´ˆê¸°í™” í•¨ìˆ˜
function initializeFilterOptions() {
    const buildingFilter = document.getElementById('building-filter');
    const floorFilter = document.getElementById('floor-filter');
    const categoryFilter = document.getElementById('category-filter');

    const buildings = [...new Set(pinsData.map(pin => pin.building))];
    const floors = [...new Set(pinsData.map(pin => pin.floor))];
    const categories = [...new Set(pinsData.map(pin => pin.category))];

    // í•„í„° ì˜µì…˜ ì±„ìš°ê¸°
    function populateFilter(filter, options, type = 'select') {
        if (type === 'checkbox') {
            filter.innerHTML = ''; // ê¸°ì¡´ ì½˜í…ì¸  ì´ˆê¸°í™”
            options.forEach(option => {
                if (option) {
                    const label = document.createElement('label');
                    label.innerHTML = `<input type="checkbox" name="category" value="${option}">${option}</label>`;
                    filter.appendChild(label);
                }
            });
        } else {
            filter.innerHTML = '<option value="">ì „ì²´</option>';
            options.forEach(option => {
                if (option) {
                    filter.innerHTML += `<option value="${option}">${option}</option>`;
                }
            });
        }
    }

    populateFilter(buildingFilter, buildings);
    populateFilter(floorFilter, floors);
    populateFilter(categoryFilter, categories, 'checkbox');
}

// ê²€ìƒ‰ ê¸°ëŠ¥
searchInput.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    if (searchTerm.length < 1) {
        searchResults.style.display = 'none';
        return;
    }

    const filteredPins = pinsData.filter(pin => 
        pin.name.toLowerCase().includes(searchTerm) ||
        pin.building.toLowerCase().includes(searchTerm) ||
        pin.description.toLowerCase().includes(searchTerm)
    );

    searchResults.innerHTML = '';
    if (filteredPins.length > 0) {
        filteredPins.forEach(pin => {
            const resultItem = document.createElement('div');
            resultItem.className = 'search-result-item';
            resultItem.innerHTML = `
                <div><strong>${pin.name}</strong></div>
                <div>${pin.building} ${pin.floor}</div>
            `;
            resultItem.addEventListener('click', () => {
                const pinObj = pins.find(p => 
                    p.coordinates.x == pin.x && 
                    p.coordinates.y == pin.y
                );

                if (pinObj) {
                    pinObj.pin.style.display = 'block'; // í•€ ê°•ì œ í‘œì‹œ
                    moveToPin(pinObj.pin);
                    showPinInfoBox(pinObj.pin, pin);
                }

                // ê²€ìƒ‰ ê²°ê³¼ ìœ ì§€
                searchResults.style.display = 'block';
                // searchInput.value = '';  //
            });
            searchResults.appendChild(resultItem);
        });
        searchResults.style.display = 'block';
    } else {
        searchResults.style.display = 'none';
    }
});

// ê²€ìƒ‰ ê²°ê³¼ì™€ ì¼ì¹˜í•˜ëŠ” í•€ë§Œ ë³´ì´ê²Œ í•˜ê¸°
function filterPinsBySearch() {
    const searchTerm = searchInput.value.toLowerCase(); // ê²€ìƒ‰ì–´ ê°€ì ¸ì˜¤ê¸°

    // ê²€ìƒ‰ì–´ê°€ í¬í•¨ëœ í•€ë§Œ í•„í„°ë§í•˜ì—¬ í‘œì‹œ
    pins.forEach(pinObj => {
        const pinData = pinObj.pin.dataset;
        const matchesSearch = (
            pinData.name && pinData.name.toLowerCase().includes(searchTerm) ||
            pinData.building && pinData.building.toLowerCase().includes(searchTerm) ||
            pinData.category && pinData.category.toLowerCase().includes(searchTerm)
        );

        if (matchesSearch) {
            pinObj.pin.style.display = 'block'; // ì¼ì¹˜í•˜ë©´ í‘œì‹œ
        } else {
            pinObj.pin.style.display = 'none'; // ì¼ì¹˜í•˜ì§€ ì•Šìœ¼ë©´ ìˆ¨ê¹€
        }
    });
    // ê²€ìƒ‰ì–´ê°€ ì—†ì„ ë•Œ
    if (searchTerm.length === 0) {
        searchResults.style.display = 'none';
        filterPins2(); // 1ìˆœìœ„ì™€ 3ìˆœìœ„ í•€ë§Œ í‘œì‹œ
        return;
    }
}

// ê²€ìƒ‰ì°½ì— ì…ë ¥ë  ë•Œë§ˆë‹¤ í•„í„°ë§ ì ìš©
searchInput.addEventListener('input', filterPinsBySearch);

// updateMapTransform í•¨ìˆ˜ ìˆ˜ì • 
function updateMapTransform() {
    const wrapperWidth = mapWrapper.offsetWidth;
    const wrapperHeight = mapWrapper.offsetHeight;
    const mapWidth = 1200 * currentScale;
    const mapHeight = 900 * currentScale;

    // ë§µì´ wrapperë³´ë‹¤ ì‘ì•„ì§€ì§€ ì•Šë„ë¡ ìµœì†Œ ìŠ¤ì¼€ì¼ ê³„ì‚°
    const minScaleX = wrapperWidth / 1200;
    const minScaleY = wrapperHeight / 900;
    const minScale = Math.max(minScaleX, minScaleY);

    // í˜„ì¬ ìŠ¤ì¼€ì¼ì´ ìµœì†Œ ìŠ¤ì¼€ì¼ë³´ë‹¤ ì‘ì•„ì§€ì§€ ì•Šë„ë¡ ì œí•œ
    if (currentScale < minScale) {
        currentScale = minScale;
    }

    // ê²½ê³„ ì œí•œ ê°•í™”
    const maxTranslateX = 0;
    const maxTranslateY = 0;
    const minTranslateX = wrapperWidth - mapWidth;
    const minTranslateY = wrapperHeight - mapHeight;

    // translate ê°’ ì œí•œ
    currentTranslateX = Math.min(maxTranslateX, Math.max(minTranslateX, currentTranslateX));
    currentTranslateY = Math.min(maxTranslateY, Math.max(minTranslateY, currentTranslateY));

    // transform ì ìš©
    mapContainer.style.transform = 
        `translate(${currentTranslateX}px, ${currentTranslateY}px) scale(${currentScale})`;

    // í•€ ì •ë³´ì°½ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
    if (activeInfoBox && selectedPin) {
        const pinRect = selectedPin.getBoundingClientRect();
        activeInfoBox.style.left = `${pinRect.left}px`;
        activeInfoBox.style.top = `${pinRect.top - 100}px`;
    }
}

function animateScroll(targetX, targetY) {
    const duration = 800; // ì• ë‹ˆë©”ì´ì…˜ ì§€ì† ì‹œê°„ (ms)
    const startX = currentTranslateX;
    const startY = currentTranslateY;
    const deltaX = targetX - startX;
    const deltaY = targetY - startY;
    const startTime = performance.now();

    function scrollStep(currentTime) {
        const progress = Math.min((currentTime - startTime) / duration, 1);
        const easeProgress = 1 - Math.pow(1 - progress, 2); // easeOutQuad

        currentTranslateX = startX + deltaX * easeProgress;
        currentTranslateY = startY + deltaY * easeProgress;

        updateMapTransform();

        if (progress < 1) {
            requestAnimationFrame(scrollStep);
        }
    }

    requestAnimationFrame(scrollStep);
}

// í•€ ìƒì„± í•¨ìˆ˜ ìˆ˜ì •
function createPin(x, y, details = {}) {
    const pin = document.createElement('div');
    pin.className = 'pin'; // ê¸°ë³¸ í´ë˜ìŠ¤
    
    // ìš°ì„ ìˆœìœ„ì— ë”°ë¼ ì¶”ê°€ í´ë˜ìŠ¤ ì ìš©
    if (details.priority === "1ìˆœìœ„") {
        pin.classList.add('pin-primary');
    } else if (details.priority === "2ìˆœìœ„") {
        pin.classList.add('pin-secondary');
    }

        // ìš°ì„ ìˆœìœ„ì— ë”°ë¼ ì¶”ê°€ í´ë˜ìŠ¤ ì ìš©
        if (details.priority === "3ìˆœìœ„") {
        pin.classList.add('pin-secondary');
    }
    
    pin.style.left = `${x}px`;
    pin.style.top = `${y}px`;

    // í•€ì˜ ìš°ì„ ìˆœìœ„ ì„¤ì •
    pin.dataset.priority = details.priority || 'ë¯¸ì •';
    pin.dataset.building = details.building || 'ë¯¸ì •';

    
    const pinLabel = document.createElement('div');
    pinLabel.innerText = details.name || 'ì´ë¦„ ì—†ìŒ';
    pinLabel.style.display = 'none';

    if (details.priority === "1ìˆœìœ„") {
        pinLabel.className = 'pin-label';
    } else if (details.priority === "2ìˆœìœ„","3ìˆœìœ„") {
        pinLabel.className = 'pin-label2';
    }

    pin.appendChild(pinLabel);

    // ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ì´ë¦„ í‘œì‹œ
    pin.addEventListener('mouseenter', () => {
        pinLabel.style.display = 'block';
    });

    pin.addEventListener('mouseleave', () => {
        pinLabel.style.display = 'none';
    });

    // ëª¨ë°”ì¼ í„°ì¹˜ ì‹œ ì´ë¦„ í‘œì‹œ
    pin.addEventListener('touchstart', (e) => {
        e.stopPropagation();
        pinLabel.style.display = 'block';
        setTimeout(() => {
            pinLabel.style.display = 'none';
        }, 2000); // 2ì´ˆ í›„ ìë™ ìˆ¨ê¹€
    });

    // í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    const handlePinInteraction = function(e) {
        e.stopPropagation();

        // 1ìˆœìœ„ í•€ì„ í´ë¦­í–ˆì„ ë•Œ ì•ˆë‚´ì°½ì„ ëœ¨ì§€ ì•Šê²Œ ì²˜ë¦¬
        if (details.priority === "1ìˆœìœ„") {
            showPriorityPins(details.building); // ê°™ì€ ê±´ë¬¼ì˜ 2ìˆœìœ„ í•€ì„ í‘œì‹œ
            showExitButton(); // Exit button appears when 2ìˆœìœ„ pins are shown
            if (activeInfoBox) {
                activeInfoBox.style.display = 'none';
            }
        } else {
            // 2ìˆœìœ„ í•€ë§Œ ì•ˆë‚´ì°½ì„ í‘œì‹œ
            showPinInfoBox(pin, details);
        }
    };

    // ë°ìŠ¤í¬í†± í´ë¦­ ì´ë²¤íŠ¸
    pin.addEventListener('click', handlePinInteraction);
    
    // ëª¨ë°”ì¼ í„°ì¹˜ ì´ë²¤íŠ¸
    pin.addEventListener('touchstart', function(e) {
        e.stopPropagation();  // ì§€ë„ì˜ í„°ì¹˜ ì´ë²¤íŠ¸ ì¤‘ì§€
        
        // í„°ì¹˜ ì‹œì‘ ì‹œê°„ ì €ì¥
        this.touchStartTime = new Date().getTime();
        this.touchStartX = e.touches[0].clientX;
        this.touchStartY = e.touches[0].clientY;
    });

    pin.addEventListener('touchend', function(e) {
        e.stopPropagation();  // ì§€ë„ì˜ í„°ì¹˜ ì´ë²¤íŠ¸ ì¤‘ì§€
        
        // í„°ì¹˜ ì¢…ë£Œ ì‹œê°„ê³¼ ì´ë™ ê±°ë¦¬ ê³„ì‚°
        const touchEndTime = new Date().getTime();
        const touchTime = touchEndTime - this.touchStartTime;
        const touchEndX = e.changedTouches[0].clientX;
        const touchEndY = e.changedTouches[0].clientY;
        const touchDistance = Math.hypot(
            touchEndX - this.touchStartX,
            touchEndY - this.touchStartY
        );

        // ì§§ì€ í„°ì¹˜(500ms ì´í•˜)ì™€ ì‘ì€ ì´ë™ ê±°ë¦¬(10px ì´í•˜)ì¼ ë•Œë§Œ í•€ ì •ë³´ í‘œì‹œ
        if (touchTime < 500 && touchDistance < 10) {
            handlePinInteraction(e);
        }
    });

    mapContainer.appendChild(pin);
    pins.push({
        pin,
        coordinates: { x, y },
        ...details
    });
}

// 1ìˆœìœ„ í•€ì„ í´ë¦­í–ˆì„ ë•Œ, í•´ë‹¹ ê±´ë¬¼ì— ì†í•˜ëŠ” 2ìˆœìœ„ í•€ ë³´ì´ê¸°
function showPriorityPins(buildingName) {
    // ëª¨ë“  1ìˆœìœ„ í•€ ìˆ¨ê¸°ê¸°
    pins.forEach(pinObj => {
        if (pinObj.pin.dataset.priority === "1ìˆœìœ„", "3ìˆœìœ„") {
            pinObj.pin.style.display = 'none'; // ëª¨ë“  1ìˆœìœ„ í•€ì„ ìˆ¨ê¹€
        }
    });

    // ëª¨ë“  í•€ ì¤‘ì—ì„œ "2ìˆœìœ„"ì´ê³ , ê±´ë¬¼ì´ í•´ë‹¹ ì´ë¦„ì¸ í•€ì„ ë³´ì´ê²Œ í•¨
    pins.forEach(pinObj => {
        if (pinObj.pin.dataset.priority === "2ìˆœìœ„" && pinObj.pin.dataset.building === buildingName) {
            pinObj.pin.style.display = 'block'; // í•´ë‹¹ 2ìˆœìœ„ í•€ì„ ë³´ì´ê²Œ í•¨
        } else if (pinObj.pin.dataset.priority === "2ìˆœìœ„") {
            pinObj.pin.style.display = 'none'; // 2ìˆœìœ„ í•€ ì¤‘ í•´ë‹¹ ê±´ë¬¼ì´ ì•„ë‹Œ ê²ƒì€ ìˆ¨ê¹€
        }
    });
}

// 2ìˆœìœ„ í•€ì´ ë³´ì¼ ë•Œ "ê±´ë¬¼ ë‚˜ê°€ê¸°" ë²„íŠ¼ê³¼ ì¸µ ë²„íŠ¼ë“¤ì„ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
function showExitButton() {
    if (exitButton === null) {
        exitButton = document.createElement('div');
        exitButton.className = 'exit-button-container';
        exitButton.style.position = 'absolute';
        exitButton.style.top = '200px';
        exitButton.style.left = '90%';
        exitButton.style.transform = 'translateX(-82%)';
        exitButton.style.display = 'flex';
        exitButton.style.flexDirection = 'column';
        exitButton.style.gap = '10px';
        
        const exitButtonElement = document.createElement('button');
        exitButtonElement.className = 'exit-button';
        exitButtonElement.innerText = 'ê±´ë¬¼ ë‚˜ê°€ê¸°';
        exitButtonElement.style.background = '#e155b5';
        exitButtonElement.style.color = 'white';
        exitButtonElement.style.padding = '8px 13px';
        exitButtonElement.style.borderRadius = '20px';
        exitButtonElement.style.whiteSpace = 'nowrap';
        exitButtonElement.style.fontSize = '14px';
        exitButtonElement.style.border = 'none';
        exitButtonElement.style.cursor = 'pointer';
        exitButtonElement.style.marginBottom = '10px';
        exitButtonElement.style.border = '2px solid rgb(213 213 213)';
        
        exitButtonElement.addEventListener('click', function() {
            hidePriorityPins();
            hideExitButton();
            filterPins2();
            if (activeInfoBox) {
                activeInfoBox.style.display = 'none';
            }
        });

        const floorButtonsContainer = document.createElement('div');
        floorButtonsContainer.style.display = 'flex';
        floorButtonsContainer.style.flexDirection = 'column';
        floorButtonsContainer.style.gap = '10px';
        floorButtonsContainer.className = 'floor-buttons-container';

        exitButton.appendChild(exitButtonElement);
        exitButton.appendChild(floorButtonsContainer);
        document.body.appendChild(exitButton);
    }

    const visibleSecondaryPin = document.querySelector('.pin[data-priority="2ìˆœìœ„"]:not([style*="display: none"])');
    if (visibleSecondaryPin) {
        const currentBuilding = visibleSecondaryPin.dataset.building;
        
        const buildingFloors = [...new Set(
            pinsData
                .filter(pin => pin.building === currentBuilding && pin.priority === "2ìˆœìœ„" && pin.floor)
                .map(pin => pin.floor)
        )];

        const floorButtonsContainer = exitButton.querySelector('.floor-buttons-container');
        floorButtonsContainer.innerHTML = '';

        // Keep track of the currently selected floor button
        let selectedButton = null;

        buildingFloors.sort().reverse().forEach(floor => {
            const floorButton = document.createElement('button');
            floorButton.className = 'floor-button';
            floorButton.innerText = floor;
            floorButton.style.background = '#4a4a4a';
            floorButton.style.color = 'white';
            floorButton.style.padding = '8px 13px';
            floorButton.style.borderRadius = '20px';
            floorButton.style.whiteSpace = 'nowrap';
            floorButton.style.fontSize = '14px';
            floorButton.style.border = 'none';
            floorButton.style.cursor = 'pointer';
            floorButton.style.border = '2px solid #f79de0';
            floorButton.style.transition = 'background-color 0.3s ease'; // Add smooth transition

            floorButton.addEventListener('click', () => {
                // Reset previously selected button
                if (selectedButton) {
                    selectedButton.style.background = '#4a4a4a';
                }
                
                // Highlight current button
                floorButton.style.background = 'rgb(195, 73, 201)'; // Change to blue when selected
                selectedButton = floorButton;

                // Show pins for selected floor
                pins.forEach(pinObj => {
                    const isTargetPin = 
                        pinObj.pin.dataset.priority === "2ìˆœìœ„" && 
                        pinObj.building === currentBuilding && 
                        pinObj.floor === floor;
                    
                    pinObj.pin.style.display = isTargetPin ? 'block' : 'none';
                });
            });
            
            floorButtonsContainer.appendChild(floorButton);
        });
    }

    exitButton.style.display = 'block';
}

// ì„ íƒëœ ì¸µì˜ í•€ë§Œ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
function highlightSelectedFloor(selectedFloor) {
    pins.forEach(pinObj => {
        if (pinObj.pin.dataset.priority === "2ìˆœìœ„") {
            // í•€ì˜ ì¸µ ì •ë³´ì™€ ì„ íƒëœ ì¸µì´ ì¼ì¹˜í•˜ëŠ” ê²½ìš°ì—ë§Œ í‘œì‹œ
            const pinFloor = pinObj.floor ? pinObj.floor.toUpperCase() : null;
            if (pinFloor === selectedFloor) {
                pinObj.pin.style.display = 'block';
            } else {
                pinObj.pin.style.display = 'none';
            }
        }
    });
}

// "ê±´ë¬¼ ë‚˜ê°€ê¸°" ë²„íŠ¼ì„ ìˆ¨ê¸°ëŠ” í•¨ìˆ˜
function hideExitButton() {
    if (exitButton) { // ë²„íŠ¼ì´ ì¡´ì¬í•  ë•Œë§Œ ì‹¤í–‰
        exitButton.style.display = 'none';
    }
}

// "1ìˆœìœ„"ë§Œ ë³´ì´ë„ë¡ 2ìˆœìœ„ í•€ì„ ìˆ¨ê¸°ëŠ” í•¨ìˆ˜
function hidePriorityPins() {
    pins.forEach(pinObj => {
        if (pinObj.pin.dataset.priority === "2ìˆœìœ„") {
            pinObj.pin.style.display = 'none'; // ëª¨ë“  2ìˆœìœ„ í•€ì„ ìˆ¨ê¹€
        }
    });
    showOnlyFirstPriorityPins(); // 1ìˆœìœ„ í•€ë§Œ ë³´ì´ê²Œ
}

// 1ìˆœìœ„ í•€ë§Œ ë³´ì´ë„ë¡ í•˜ëŠ” í•¨ìˆ˜
function showOnlyFirstPriorityPins() {
    pins.forEach(pinObj => {
        if (pinObj.pin.dataset.priority === "1ìˆœìœ„") {
            pinObj.pin.style.display = 'block'; // 1ìˆœìœ„ í•€ë§Œ ë³´ì´ê²Œ í•¨
        }
    });
}


// í•€ ì •ë³´ì°½ í‘œì‹œ í•¨ìˆ˜
function showPinInfoBox(pin, pinData) {
    if (activeInfoBox) {
        activeInfoBox.remove();
    }

    const pinRect = pin.getBoundingClientRect();
    const infoBox = document.createElement('div');
    infoBox.className = 'pin-info-box';
    
    // ëª¨ë°”ì¼ ì—¬ë¶€ í™•ì¸
    const isMobile = window.innerWidth <= 768;
    
    if (isMobile) {
        // ëª¨ë°”ì¼ì—ì„œëŠ” í™”ë©´ ì¤‘ì•™ì— í‘œì‹œ
        infoBox.style.left = '50%';
        infoBox.style.top = '50%';
        infoBox.style.transform = 'translate(-50%, -50%)';
    } else {
        // ë°ìŠ¤í¬í†±ì—ì„œëŠ” ê¸°ì¡´ ìœ„ì¹˜ ìœ ì§€
        infoBox.style.left = `${pinRect.left + 100}px`;
        infoBox.style.top = `${pinRect.top - 100}px`;
    }
    
    infoBox.style.left = `${pinRect.left + 100}px`;
    infoBox.style.top = `${pinRect.top - 100}px`;

    const closeBtn = document.createElement('span');
    closeBtn.className = 'close-btn';
    closeBtn.innerHTML = 'Ã—';
    closeBtn.onclick = function(e) {
        e.stopPropagation();
        infoBox.style.display = 'none';
        activeInfoBox = null;
    };
    infoBox.appendChild(closeBtn);

    // ê°’ì´ ìˆëŠ” í•­ëª©ë§Œ í‘œì‹œí•˜ë„ë¡ ìˆ˜ì •
    const info = [];
    if (pinData.name) info.push(`<strong>ì´ë¦„:</strong> ${pinData.name}`);
    if (pinData.building) info.push(`<strong>ê±´ë¬¼:</strong> ${pinData.building}`);
    if (pinData.floor) info.push(`<strong>ì¸µ:</strong> ${pinData.floor}`);
    if (pinData.category) info.push(`<strong>ì¹´í…Œê³ ë¦¬:</strong> ${pinData.category}`);
    if (pinData.description) info.push(`<strong>ì„¤ëª…:</strong> ${pinData.description}`);
    if (pinData.address) info.push(`<strong>ì£¼ì†Œ:</strong> <a href="${pinData.address}" target="_blank">${pinData.address}</a>`);

    infoBox.innerHTML += info.join('<br>');
    
    document.body.appendChild(infoBox);
    infoBox.style.display = 'block';
    activeInfoBox = infoBox;
    selectedPin = pin;

    // ì •ë³´ì°½ì´ í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šë„ë¡ ì¡°ì •
    const infoBoxRect = infoBox.getBoundingClientRect();
    if (infoBoxRect.top < 0) {
        infoBox.style.top = '10px';
    }
    if (infoBoxRect.left < 0) {
        infoBox.style.left = '10px';
    }
    if (infoBoxRect.right > window.innerWidth) {
        infoBox.style.left = `${window.innerWidth - infoBoxRect.width - 10}px`;
    }

        // í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        closeBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        infoBox.remove();
        activeInfoBox = null;
        selectedPin = null;
    });

    infoBox.appendChild(closeBtn);
}

// í•„í„°ë§ í•¨ìˆ˜
function filterPins() {
    const buildingFilter = document.getElementById('building-filter').value;
    const floorFilter = document.getElementById('floor-filter').value;
    
    // ì„ íƒëœ ì¹´í…Œê³ ë¦¬ ì²´í¬ë°•ìŠ¤ ê°’ ê°€ì ¸ì˜¤ê¸°
    const selectedCategories = [...document.querySelectorAll('input[name="category"]:checked')]
        .map(checkbox => checkbox.value);
    
    // ê²€ìƒ‰ì–´ ê°€ì ¸ì˜¤ê¸°
    const searchTerm = searchInput.value.trim().toLowerCase();
    
    // í•„í„° ë° ê²€ìƒ‰ì´ ëª¨ë‘ ë¹„ì–´ìˆìœ¼ë©´ filterPins2 ì‹¤í–‰
    if (!buildingFilter && !floorFilter && selectedCategories.length === 0 && searchTerm === "") {
        filterPins2(); // 1ìˆœìœ„ì™€ 3ìˆœìœ„ í•€ë§Œ í‘œì‹œ
        return;
    }

    // í•„í„°ë§ ì ìš©
    pins.forEach(pinObj => {
        const matchesBuilding = !buildingFilter || pinObj.building === buildingFilter;
        const matchesFloor = !floorFilter || pinObj.floor === floorFilter;
        const matchesCategory = selectedCategories.length === 0 || selectedCategories.includes(pinObj.category);
        const matchesSearch = (
            pinObj.name && pinObj.name.toLowerCase().includes(searchTerm) ||
            pinObj.building && pinObj.building.toLowerCase().includes(searchTerm) ||
            pinObj.category && pinObj.category.toLowerCase().includes(searchTerm)
        );

        if (matchesBuilding && matchesFloor && matchesCategory && matchesSearch) {
            pinObj.pin.style.display = 'block';
        } else {
            pinObj.pin.style.display = 'none';
        }
    });
}

// í•„í„°ë§ í•¨ìˆ˜ ìˆ˜ì • - ìµœì´ˆ ì‹¤í–‰ì‹œ 1ìˆœìœ„ í•€ë§Œ ë³´ì´ë„ë¡
function filterPins2() {
    const priorityFilter = "1ìˆœìœ„";
    
    pins.forEach(pinObj => {
        // 1ìˆœìœ„ì´ê±°ë‚˜ 3ìˆœìœ„ì¸ í•€ë§Œ í‘œì‹œ
        const matchesPriority = pinObj.priority === priorityFilter || pinObj.priority === "3ìˆœìœ„";
        
        if (matchesPriority) {
            pinObj.pin.style.display = 'block';
        } else {
            pinObj.pin.style.display = 'none';
        }
    });
}

// íŠ¹ì • í•€ìœ¼ë¡œ ì´ë™í•˜ëŠ” í•¨ìˆ˜
function moveToPin(pin) {
    const pinRect = pin.getBoundingClientRect();
    const wrapperRect = mapWrapper.getBoundingClientRect();
    
    const targetX = -(pin.offsetLeft * currentScale - (wrapperRect.width / 2));
    const targetY = -(pin.offsetTop * currentScale - (wrapperRect.height / 2));
    
    mapContainer.style.transition = 'transform 0.5s ease-out';
    currentTranslateX = targetX;
    currentTranslateY = targetY;
    updateMapTransform();
    
    setTimeout(() => {
        mapContainer.style.transition = '';
    }, 500);
}

// í„°ì¹˜ ì´ë²¤íŠ¸ ê´€ë ¨ ë³€ìˆ˜
let initialTouchDistance = 0;
let lastTouchX = 0;
let lastTouchY = 0;
let isTouching = false;
let lastTapTime = 0;
let initialPinchScale = 1;
let pinchStartX = 0;  // í•€ì¹˜ ì‹œì‘ X ì¢Œí‘œ
let pinchStartY = 0;  // í•€ì¹˜ ì‹œì‘ Y ì¢Œí‘œ
let exitButton = null;

// í„°ì¹˜ ì‹œì‘ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
mapContainer.addEventListener('touchstart', function(e) {
    e.preventDefault();
    isTouching = true;
    
    if (e.touches.length === 1) {
        // ì‹±ê¸€ í„°ì¹˜ (ì´ë™)
        const touch = e.touches[0];
        lastTouchX = touch.clientX;
        lastTouchY = touch.clientY;
        
        // ë”ë¸” íƒ­ í™•ì¸
        const currentTime = new Date().getTime();
        const tapLength = currentTime - lastTapTime;
        
        if (tapLength < 300 && tapLength > 0) {
            // ë”ë¸” íƒ­ í™•ëŒ€
            const touch = e.touches[0];
            const targetScale = currentScale === mapConfig.maxScale ? 
                mapConfig.minScale : Math.min(currentScale * 2, mapConfig.maxScale);
            
            smoothZoom(targetScale, touch.clientX, touch.clientY);
        }
        
        lastTapTime = currentTime;
        
    } else if (e.touches.length === 2) {
        // ë©€í‹° í„°ì¹˜ (í•€ì¹˜ ì¤Œ)
        const touch1 = e.touches[0];
        const touch2 = e.touches[1];
        
        // í•€ì¹˜ ì‹œì‘ ì§€ì  ì €ì¥ (ë‘ ì†ê°€ë½ì˜ ì¤‘ì‹¬ì )
        pinchStartX = (touch1.clientX + touch2.clientX) / 2;
        pinchStartY = (touch1.clientY + touch2.clientY) / 2;
        
        initialTouchDistance = Math.hypot(
            touch2.clientX - touch1.clientX,
            touch2.clientY - touch1.clientY
        );
        initialPinchScale = currentScale;
    }
});

// í„°ì¹˜ ì´ë™ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
mapContainer.addEventListener('touchmove', function(e) {
    e.preventDefault();
    
    if (!isTouching) return;
    
    if (e.touches.length === 1) {
        // ì‹±ê¸€ í„°ì¹˜ (ì´ë™)
        const touch = e.touches[0];
        const deltaX = touch.clientX - lastTouchX;
        const deltaY = touch.clientY - lastTouchY;
        
        currentTranslateX += deltaX;
        currentTranslateY += deltaY;
        
        lastTouchX = touch.clientX;
        lastTouchY = touch.clientY;
        
        updateMapTransform();
        
    } else if (e.touches.length === 2) {
        // ë©€í‹° í„°ì¹˜ (í•€ì¹˜ ì¤Œ)
        const touch1 = e.touches[0];
        const touch2 = e.touches[1];
        
        // í˜„ì¬ í„°ì¹˜ í¬ì¸íŠ¸ ê°„ì˜ ê±°ë¦¬ ê³„ì‚°
        const currentTouchDistance = Math.hypot(
            touch2.clientX - touch1.clientX,
            touch2.clientY - touch1.clientY
        );
        
        // ìŠ¤ì¼€ì¼ ê³„ì‚°
        const scaleFactor = currentTouchDistance / initialTouchDistance;
        const targetScale = Math.min(
            Math.max(
                mapConfig.minScale,
                initialPinchScale * scaleFactor
            ),
            mapConfig.maxScale
        );
        
        // í•€ì¹˜ ì‹œì‘ ì§€ì ì„ ê¸°ì¤€ìœ¼ë¡œ í™•ëŒ€/ì¶•ì†Œ
        const rect = mapWrapper.getBoundingClientRect();
        const mouseX = pinchStartX - rect.left;
        const mouseY = pinchStartY - rect.top;
        
        // ë§µ ìƒì˜ ë§ˆìš°ìŠ¤ ìœ„ì¹˜ ê³„ì‚°
        const mapX = (mouseX - currentTranslateX) / currentScale;
        const mapY = (mouseY - currentTranslateY) / currentScale;
        
        // ì¦‰ì‹œ í™•ëŒ€/ì¶•ì†Œ ì ìš©
        currentScale = targetScale;
        
        // í•€ì¹˜ ì‹œì‘ ì§€ì ì„ ê¸°ì¤€ìœ¼ë¡œ ìƒˆë¡œìš´ translate ê°’ ê³„ì‚°
        currentTranslateX = mouseX - (mapX * currentScale);
        currentTranslateY = mouseY - (mapY * currentScale);
        
        updateMapTransform();
    }
});

// í„°ì¹˜ ì¢…ë£Œ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
mapContainer.addEventListener('touchend', function(e) {
    isTouching = false;
    initialTouchDistance = 0;
    initialPinchScale = currentScale;
    pinchStartX = 0;
    pinchStartY = 0;
    
    // ë°”ìš´ìŠ¤ íš¨ê³¼ ì ìš©
    const wrapperWidth = mapWrapper.offsetWidth;
    const wrapperHeight = mapWrapper.offsetHeight;
    const mapWidth = 1200 * currentScale;
    const mapHeight = 900 * currentScale;
    
    const minX = Math.min(0, wrapperWidth - mapWidth);
    const minY = Math.min(0, wrapperHeight - mapHeight);
    
    if (currentTranslateX < minX || currentTranslateX > 0 ||
        currentTranslateY < minY || currentTranslateY > 0) {
        
        mapContainer.style.transition = 'transform 0.3s ease-out';
        currentTranslateX = Math.max(minX, Math.min(0, currentTranslateX));
        currentTranslateY = Math.max(minY, Math.min(0, currentTranslateY));
        updateMapTransform();
        
        setTimeout(() => {
            mapContainer.style.transition = '';
        }, 300);
    }
});

// í„°ì¹˜ ì·¨ì†Œ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
mapContainer.addEventListener('touchcancel', function() {
    isTouching = false;
    initialTouchDistance = 0;
    initialPinchScale = currentScale;
    pinchStartX = 0;
    pinchStartY = 0;
});

// ë¶€ë“œëŸ¬ìš´ ì¤Œ í•¨ìˆ˜
function smoothZoom(targetScale, mouseX, mouseY) {
    const startScale = currentScale;
    const scaleDiff = targetScale - startScale;
    const duration = 300;
    
    if (zoomAnimation) {
        cancelAnimationFrame(zoomAnimation);
    }

    // í˜„ì¬ ë·°í¬íŠ¸ ìƒì˜ ë§ˆìš°ìŠ¤ ìœ„ì¹˜
    const viewportX = mouseX;
    const viewportY = mouseY;

    // í˜„ì¬ ë§µ ìƒì˜ ë§ˆìš°ìŠ¤ ìœ„ì¹˜ ê³„ì‚°
    const mapX = (viewportX - currentTranslateX) / currentScale;
    const mapY = (viewportY - currentTranslateY) / currentScale;

    const startTime = performance.now();
    
    function animate(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // easeOutQuad ì´ì§• í•¨ìˆ˜ ì‚¬ìš©
        const easeProgress = 1 - (1 - progress) * (1 - progress);
        const newScale = startScale + (scaleDiff * easeProgress);
        
        // ìƒˆë¡œìš´ translate ê°’ ê³„ì‚°
        // ë§ˆìš°ìŠ¤ ìœ„ì¹˜ëŠ” ê³ ì •ëœ ì±„ë¡œ í™•ëŒ€/ì¶•ì†Œë˜ì–´ì•¼ í•¨
        const newTranslateX = viewportX - (mapX * newScale);
        const newTranslateY = viewportY - (mapY * newScale);

        // ê²½ê³„ í™•ì¸
        const mapWidth = 1200 * newScale;
        const mapHeight = 900 * newScale;
        const wrapperWidth = mapWrapper.offsetWidth;
        const wrapperHeight = mapWrapper.offsetHeight;

        // ë§µì´ í™”ë©´ ë°–ìœ¼ë¡œ ë„ˆë¬´ ë§ì´ ë‚˜ê°€ì§€ ì•Šë„ë¡ ì œí•œ
        const minX = Math.min(0, wrapperWidth - mapWidth);
        const minY = Math.min(0, wrapperHeight - mapHeight);

        currentScale = newScale;
        currentTranslateX = Math.max(minX, Math.min(0, newTranslateX));
        currentTranslateY = Math.max(minY, Math.min(0, newTranslateY));
        
        updateMapTransform();
        
        if (progress < 1) {
            zoomAnimation = requestAnimationFrame(animate);
        }
    }
    
    zoomAnimation = requestAnimationFrame(animate);
}

// ë§ˆìš°ìŠ¤ ë‹¤ìš´ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì¶”ê°€
mapContainer.addEventListener('mousedown', (e) => {
    isDragging = true;
    startX = e.clientX;
    startY = e.clientY;
    mapContainer.style.cursor = 'grabbing';
});

// ë§ˆìš°ìŠ¤ ì´ë™ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì—…ë°ì´íŠ¸
document.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    e.preventDefault();
    const deltaX = e.clientX - startX;
    const deltaY = e.clientY - startY;
    
    currentTranslateX += deltaX;
    currentTranslateY += deltaY;
    
    startX = e.clientX;
    startY = e.clientY;
    
    updateMapTransform();
});

document.addEventListener('mouseup', () => {
    isDragging = false;
    mapContainer.style.cursor = 'grab';
});

// Xí‚¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
document.addEventListener('keydown', function(e) {
    if (e.key === 'x' || e.key === 'X') {
        if (activeInfoBox) {
            activeInfoBox.style.display = 'none';
            activeInfoBox = null;
        }
        if (searchResults.style.display === 'block') {
            searchResults.style.display = 'none';
            searchInput.value = '';
        }
    }
});

function generateBuildingList() {
    // 2ìˆœìœ„ í•€ë“¤ë§Œ í•„í„°ë§
    const secondaryPins = pinsData.filter(pin => pin.priority === "2ìˆœìœ„");
    
    // ê±´ë¬¼ë³„ë¡œ ê·¸ë£¹í™”
    const buildingGroups = {};
    secondaryPins.forEach(pin => {
        if (!buildingGroups[pin.building]) {
            buildingGroups[pin.building] = new Set();
        }
        if (pin.floor) {
            buildingGroups[pin.building].add(pin.floor);
        }
    });

    // ê±´ë¬¼ ë¦¬ìŠ¤íŠ¸ HTML ìƒì„±
    const buildingContainer = document.querySelector('.building-container');
    buildingContainer.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”

    // X ë²„íŠ¼ ì¶”ê°€
    const closeButton = document.createElement('div');
    closeButton.innerHTML = '&times;';
    closeButton.style.cssText = `
        position: sticky;
        top: 10px;
        right: 10px;
        font-size: 24px;
        cursor: pointer;
        float: right;
        padding: 5px 10px;
        z-index: 1000;
    `;
    closeButton.addEventListener('click', () => {
        document.querySelector('.building-list').style.display = 'none';
        filterPins2()
        if (activeInfoBox) {
                activeInfoBox.style.display = 'none';
            }
    });
    buildingContainer.appendChild(closeButton);
    
    Object.entries(buildingGroups).forEach(([building, floors]) => {
        const buildingSection = document.createElement('div');
        buildingSection.className = 'building-section';
        
        // ê±´ë¬¼ëª… í—¤ë”
        const header = document.createElement('h3');
        header.textContent = building;
        buildingSection.appendChild(header);

        // ì¸µ ë²„íŠ¼ë“¤ì„ ë‹´ì„ ì»¨í…Œì´ë„ˆ
        const floorList = document.createElement('div');
        floorList.className = 'floor-list';

        // ì¸µ ì •ë³´ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ ì¸µ ë²„íŠ¼ ìƒì„±
        if (floors.size > 0) {
            // ì¸µ ì •ë³´ë¥¼ ì •ë ¬ (ìˆ«ì ìˆœ)
            const sortedFloors = Array.from(floors).sort((a, b) => {
                const numA = parseInt(a);
                const numB = parseInt(b);
                return numB - numA;  // ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
            });

            sortedFloors.forEach(floor => {
                const floorButton = document.createElement('button');
                floorButton.className = 'floor-item';
                floorButton.textContent = floor;
                
                // ì¸µ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
                floorButton.addEventListener('click', () => {
                    // í•´ë‹¹ ê±´ë¬¼ì˜ í•´ë‹¹ ì¸µì— ìˆëŠ” 2ìˆœìœ„ í•€ë§Œ í‘œì‹œ
                    pins.forEach(pinObj => {
                        if (pinObj.pin.dataset.priority === "2ìˆœìœ„" && 
                            pinObj.building === building && 
                            pinObj.floor === floor) {
                            pinObj.pin.style.display = 'block';
                            if (activeInfoBox) {
                                activeInfoBox.style.display = 'none';
                            }
                        } else {
                            pinObj.pin.style.display = 'none';
                        }
                    });
                });
                
                floorList.appendChild(floorButton);
            });
        }

        buildingSection.appendChild(floorList);

        // ê±´ë¬¼ë³„ ìœ„ì¹˜ ë¦¬ìŠ¤íŠ¸ ìƒì„±
        const locationsList = document.createElement('div');
        locationsList.className = 'locations-list';
        
        // í•´ë‹¹ ê±´ë¬¼ì˜ 2ìˆœìœ„ í•€ë“¤ í‘œì‹œ
        secondaryPins.filter(pin => pin.building === building).forEach(pin => {
            const locationItem = document.createElement('div');
            locationItem.className = 'location-item';
            locationItem.textContent = `${pin.floor ? pin.floor + ' - ' : ''}${pin.name || 'ì´ë¦„ ì—†ìŒ'}`;
            
            // ìœ„ì¹˜ í•­ëª© í´ë¦­ ì´ë²¤íŠ¸
            locationItem.addEventListener('click', () => {
                const pinObj = pins.find(p => 
                    p.coordinates.x == pin.x && 
                    p.coordinates.y == pin.y
                );
                if (pinObj) {
                    // í•´ë‹¹ í•€ë§Œ í‘œì‹œí•˜ê³  ë‚˜ë¨¸ì§€ëŠ” ìˆ¨ê¹€
                    pins.forEach(p => {
                        p.pin.style.display = 'none';
                    });
                    pinObj.pin.style.display = 'block';
                    moveToPin(pinObj.pin);
                    showPinInfoBox(pinObj.pin, pin);
                }
            });
            
            locationsList.appendChild(locationItem);
        });

        buildingSection.appendChild(locationsList);
        buildingContainer.appendChild(buildingSection);
    });
}

// ê±´ë¬¼ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ìˆ˜ì •
document.querySelector('.nav-item:nth-child(2)').addEventListener('click', function(e) {
    e.preventDefault();
    const buildingList = document.querySelector('.building-list');
    if (buildingList.style.display === 'none') {
        generateBuildingList(); // ë¦¬ìŠ¤íŠ¸ í‘œì‹œ ì „ì— ë™ì ìœ¼ë¡œ ìƒì„±
        buildingList.style.display = 'block';
    } else {
        buildingList.style.display = 'none';
    }
    
});

// ì™¸ë¶€ í´ë¦­ ì‹œ ë¦¬ìŠ¤íŠ¸ ë‹«ê¸° ì´ë²¤íŠ¸
document.addEventListener('click', function(e) {
    const buildingList = document.querySelector('.building-list');
    const navItem = document.querySelector('.nav-item:nth-child(2)');
    
    if (buildingList && buildingList.style.display !== 'none' &&
        !buildingList.contains(e.target) && !navItem.contains(e.target)) {
        buildingList.style.display = 'none';
        filterPins2()
        if (activeInfoBox) {
                activeInfoBox.style.display = 'none';
            }
    }
});

document.addEventListener("DOMContentLoaded", function () {
    const popup = document.getElementById("popup");
    const openPopup = document.getElementById("openPopup");
    const closePopup = document.querySelector(".close");

    // íŒì—… ì—´ê¸°
    openPopup.addEventListener("click", function (event) {
        event.preventDefault(); // ê¸°ë³¸ ë§í¬ ë™ì‘ ë°©ì§€
        popup.style.display = "flex";
    });

    // íŒì—… ë‹«ê¸° (X ë²„íŠ¼)
    closePopup.addEventListener("click", function () {
        popup.style.display = "none";
    });

    // íŒì—… ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    window.addEventListener("click", function (event) {
        if (event.target === popup) {
            popup.style.display = "none";
        }
    });
});

// wheel ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ìˆ˜ì •
mapWrapper.addEventListener('wheel', function(e) {
    e.preventDefault();
    
    const rect = mapWrapper.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;

    // í˜„ì¬ ë§µì˜ í¬ê¸° ê³„ì‚°
    const wrapperWidth = mapWrapper.offsetWidth;
    const wrapperHeight = mapWrapper.offsetHeight;
    const minScaleX = wrapperWidth / 1200;
    const minScaleY = wrapperHeight / 900;
    const minScale = Math.max(minScaleX, minScaleY);

    const delta = -e.deltaY / Math.abs(e.deltaY); // ë°©í–¥ë§Œ ì¶”ì¶œ (+1 ë˜ëŠ” -1)
    
    // ì¶•ì†Œí•˜ë ¤ê³  í•  ë•Œ (delta < 0) ìµœì†Œ ìŠ¤ì¼€ì¼ì— ë„ë‹¬í–ˆë‹¤ë©´ ë” ì´ìƒ ì¶•ì†Œí•˜ì§€ ì•ŠìŒ
    if (delta < 0 && currentScale <= minScale) {
        return;
    }
    
    const zoomFactor = 0.6; // ì¤Œ ì†ë„ ì¡°ì ˆ (ê°’ì´ ì‘ì„ìˆ˜ë¡ ë¶€ë“œëŸ¬ì›€)
    const targetScale = Math.min(
        Math.max(
            minScale,
            currentScale * (1 + delta * zoomFactor)
        ),
        mapConfig.maxScale
    );
    
    // í˜„ì¬ ìŠ¤ì¼€ì¼ê³¼ ëª©í‘œ ìŠ¤ì¼€ì¼ì´ ì¶©ë¶„íˆ ë‹¤ë¥¸ ê²½ìš°ì—ë§Œ ì¤Œ ì‹¤í–‰
    if (Math.abs(targetScale - currentScale) > 0.01) {
        smoothZoom(targetScale, mouseX, mouseY);
    }
});

// í´ë¦­ ì´ë²¤íŠ¸ë¡œ ì •ë³´ì°½ê³¼ ê²€ìƒ‰ê²°ê³¼ ë‹«ê¸°
// mapWrapper.addEventListener('click', function() {
//     if (activeInfoBox) {
//         activeInfoBox.style.display = 'none';
//         activeInfoBox = null;
//     }
//     searchResults.style.display = 'none';
//     searchInput.value = '';
// });

// ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ì´ë²¤íŠ¸
window.addEventListener('resize', function() {
    updateMapTransform();
    if (activeInfoBox && selectedPin) {
        const pinRect = selectedPin.getBoundingClientRect();
        activeInfoBox.style.left = `${pinRect.left}px`;
        activeInfoBox.style.top = `${pinRect.top - 100}px`;
    }
});

// ì•± ì´ˆê¸°í™”
function initializeMap() {
    // ëª¨ë°”ì¼ ì—¬ë¶€ í™•ì¸
    const isMobile = window.innerWidth <= 768;
    
    // ëª¨ë°”ì¼/ë°ìŠ¤í¬í†±ì— ë”°ë¥¸ ì´ˆê¸° ì„¤ì • ì ìš©
    currentScale = isMobile ? mapConfig.mobile.initialScale : mapConfig.initialScale;
    
    const wrapperWidth = mapWrapper.offsetWidth;
    const wrapperHeight = mapWrapper.offsetHeight;
    const mapWidth = 1200 * currentScale;
    const mapHeight = 900 * currentScale;
    
    if (isMobile) {
        currentTranslateX = mapConfig.mobile.initialX;
        currentTranslateY = mapConfig.mobile.initialY;
    } else {
        if (mapConfig.initialX === 0 && mapConfig.initialY === 0) {
            currentTranslateX = (wrapperWidth - mapWidth) / 2;
            currentTranslateY = (wrapperHeight - mapHeight) / 2;
        } else {
            currentTranslateX = mapConfig.initialX;
            currentTranslateY = mapConfig.initialY;
        }
    }
    
    updateMapTransform();
}

// í•„í„° ì„¤ì •
function setupFilters() {
    const filters = ['building-filter', 'floor-filter', 'category-filter'];
    filters.forEach(filterId => {
        document.getElementById(filterId).addEventListener('change', filterPins);
    });
}

function handleUrlPinLocation() {
    const path = window.location.pathname;
    const locationName = decodeURIComponent(path.split('/').pop());

    let matchedPin = null;
    let matchedSubstring = '';

    // pinsData ë°°ì—´ì„ ìˆœíšŒí•˜ë©° locationNameì´ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
    for (const pin of pinsData) {
        // pin.nameì— í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ í•´ë‹¹ ë¶€ë¶„ ì¶”ì¶œ
        if (pin.name.includes(locationName)) {
            matchedPin = pin;
            const startIndex = pin.name.indexOf(locationName);
            matchedSubstring = pin.name.substring(startIndex, startIndex + locationName.length);
            break; // ì²«ë²ˆì§¸ ë§¤ì¹­ëœ í•€ì„ ì°¾ìœ¼ë©´ ì¢…ë£Œ
        }
        // ë§Œì•½ pin.buildingì— í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ í•´ë‹¹ ë¶€ë¶„ ì¶”ì¶œ
        if (pin.building.includes(locationName)) {
            matchedPin = pin;
            const startIndex = pin.building.indexOf(locationName);
            matchedSubstring = pin.building.substring(startIndex, startIndex + locationName.length);
            break;
        }
    }

    if (matchedPin) {
        console.log("ë§¤ì¹­ëœ ë¶€ë¶„:", matchedSubstring);

        // ëª¨ë“  í•€ ìˆ¨ê¸°ê¸°
        pins.forEach(p => {
            p.pin.style.display = 'none';
        });

        // pins ë°°ì—´ì—ì„œ ì¢Œí‘œê°€ ì¼ì¹˜í•˜ëŠ” í•€ ê°ì²´ ì°¾ê¸°
        const pinObj = pins.find(p =>
            p.coordinates.x === matchedPin.x &&
            p.coordinates.y === matchedPin.y
        );

        if (pinObj) {
            // í•´ë‹¹ í•€ë§Œ í‘œì‹œ
            pinObj.pin.style.display = 'block';

            // í•€ ê°•ì¡° ìŠ¤íƒ€ì¼ ì ìš© (í¬ê¸° 1.5ë°°, ì•ìª½ í‘œì‹œ, ë¹›ë‚˜ëŠ” íš¨ê³¼)
            pinObj.pin.style.transform = 'translate(-50%, -95%) scale(1.5)';
            pinObj.pin.style.zIndex = '1001';
            pinObj.pin.style.filter = 'drop-shadow(0 0 10px rgba(233, 30, 99, 0.8))';

            moveToPin(pinObj.pin);
            showPinInfoBox(pinObj.pin, matchedPin);

            // ì „ì²´ ì§€ë„ë³´ê¸° ë²„íŠ¼ ìƒì„±
            const viewAllButton = document.createElement('button');
            viewAllButton.innerText = 'ì „ì²´ ì§€ë„ ë³´ê¸°';
            viewAllButton.style.cssText = `
                position: fixed;
                bottom: 100px;
                left: 50%;
                transform: translateX(-50%);
                padding: 12px 24px;
                background: #e155b5;
                color: white;
                border: none;
                border-radius: 20px;
                font-size: 16px;
                cursor: pointer;
                box-shadow: 0 2px 6px rgba(0,0,0,0.2);
                z-index: 1002;
            `;

            viewAllButton.addEventListener('click', () => {
                // ê°•ì¡° íš¨ê³¼ ì œê±° ë° ëª¨ë“  í•€ ë‹¤ì‹œ í‘œì‹œ (filterPins2 í•¨ìˆ˜ ì‚¬ìš©)
                pinObj.pin.style.transform = 'translate(-50%, -95%)';
                pinObj.pin.style.filter = 'none';
                filterPins2(); // 1ìˆœìœ„ì™€ 3ìˆœìœ„ í•€ í‘œì‹œ

                // ì •ë³´ì°½ ë‹«ê¸°
                if (activeInfoBox) {
                    activeInfoBox.style.display = 'none';
                }

                // ë²„íŠ¼ ì œê±°
                viewAllButton.remove();
            });

            document.body.appendChild(viewAllButton);
        }
    } else {
        alert(`"${locationName}"ì— í•´ë‹¹í•˜ëŠ” ìœ„ì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const pathParts = window.location.pathname.split('/');
    const locationName = pathParts[pathParts.length - 1];
    
    if (locationName && locationName !== 'DIMAMAP') {
        setTimeout(handleUrlPinLocation, 500);
    }
});

// DOMì´ ë¡œë“œë˜ë©´ ì‹¤í–‰
document.addEventListener('DOMContentLoaded', function() {
    initializeMap();
    initializeFilterOptions();
    setupFilters();
    
    // ëª¨ë“  í•€ ìƒì„±
    pinsData.forEach(pinData => createPin(pinData.x, pinData.y, pinData));
    
    // ìµœì´ˆ ì‹¤í–‰ ì‹œ 1ìˆœìœ„ í•€ë§Œ í‘œì‹œ
    filterPins2();
    
    // ë¶ˆí•„ìš”í•œ í•„í„° ì ìš© ë²„íŠ¼ ì œê±°
    const applyButton = document.getElementById('apply-filters');
    if (applyButton) {
        applyButton.remove();
    }
});

document.addEventListener('contextmenu', function(event) {
    event.preventDefault();  // ìš°í´ë¦­ ë°©ì§€
});
    </script>
</body>
</html>
